[
  {
    "name": "moh-731-12month-allsites-cohort",
    "table":{"schema":"etl","tableName":"flat_hiv_summary","alias":"t1"},
    "joins":[],
    "parameters": [
      {"name":"locations","defaultValue":[]},
      {"name":"endDate", "defaultValue":"2015-10-31"},
      {"name":"startDate", "defaultValue":"2015-10-31"},
      {"name":"groupByPerson", "defaultValue":[
        {"label":"person_id","expression":"t1.person_id"}
      ]
      }
    ],
    "filters": [
      {"expression":"t1.location_id in ?","parameter":"locations"},
      {"expression":"date(t1.arv_start_date) >= DATE_SUB( ?, INTERVAL 1 YEAR)", "parameter":"startDate"},
      {"expression":"date(t1.arv_start_date) <= DATE_SUB( ?, INTERVAL 1 YEAR)", "parameter":"endDate"},
      {"expression":"t1.is_clinical_encounter = 1"}
    ],
    "groupClause":[
      {"parameter":"groupByPerson"}
    ],
    "indicators": [],
    "supplementColumns":[
      {
        "label":"person_id",
        "type":"single",
        "sql":"t1.person_id"
      },
      {
        "label":"location_uuid",
        "type":"single",
        "sql":"t1.location_uuid"
      },
      {
        "label":"location_id",
        "type":"single",
        "sql":"t1.location_id"
      },
      {
        "label":"cur_arv_line",
        "type":"single",
        "sql":"mid(max(concat(encounter_datetime,cur_arv_line)),20)"
      },
      {
        "label":"cur_arv_meds",
        "type":"single",
        "sql":"mid(max(concat(encounter_datetime,cur_arv_meds)),20)"
      },
      {
        "label":"arv_first_regimen",
        "type":"single",
        "sql":"mid(max(concat(encounter_datetime,arv_first_regimen)),20)"
      },
      {
        "label":"rtc_date",
        "type":"single",
        "sql":"mid(max(concat(encounter_datetime,rtc_date)),20)"
      },
      {
        "label":"encounter_datetime",
        "type":"single",
        "sql":"max(encounter_datetime)"
      },
      {
        "label":"death_date",
        "type":"single",
        "sql":"max(death_date)"
      },
      {
        "label":"transfer_out",
        "type":"single",
        "sql":"max(transfer_out)"
      },
      {
        "label":"out_of_care",
        "type":"single",
        "sql":"max(out_of_care)"
      },
      {
        "label":"arv_start_date",
        "type":"single",
        "sql":"arv_start_date"
      }
    ]
  },
  {
    "name": "moh-731-cummulative-allsites-cohort",
    "table":{"schema":"etl","tableName":"flat_hiv_summary","alias":"t1"},
    "joins":[
      {"joinType":"INNER JOIN","schema":"amrs","tableName":"location","alias":"t2","joinExpression":"t1.location_uuid = t2.uuid"},
      {"joinType":"INNER JOIN","schema":"amrs","tableName":"person","alias":"t3","joinExpression":"t1.person_id = t3.person_id"}
    ],
    "parameters": [
      {"name":"locations","defaultValue":[]},
      {"name":"endDate", "defaultValue":["Now()"]},
      {"name":"groupByPerson", "defaultValue":[
        {"label":"person_id","expression":"t1.person_id"}
      ]
      }
    ],
    "filters": [
      {"expression":"t1.location_id in ?","parameter":"locations"},
      {"expression":"t1.is_clinical_encounter = 1"},
      {"expression":"arv_start_date is not null", "processForce":true},
      {"expression":"arv_start_location=t1.location_id", "processForce":true},
      {"expression":"t1.encounter_datetime <= ?", "parameter":"endDate"}
    ],
    "groupClause":[
      {"parameter":"groupByPerson"}
    ],
    "indicators": [],
    "supplementColumns":[
      {
        "label":"person_id",
        "type":"single",
        "sql":"t1.person_id"
      },
      {
        "label":"location_uuid",
        "type":"single",
        "sql":"t1.location_uuid"
      },
      {
        "label":"location_id",
        "type":"single",
        "sql":"t1.location_id"
      },
      {
        "label":"birthdate",
        "type":"single",
        "sql":"t3.birthdate"
      },
      {
        "label":"arv_start_date",
        "type":"single",
        "sql":"arv_start_date"
      },
      {
        "label":"enrollment_date",
        "type":"single",
        "sql":"min(enrollment_date)"
      },
      {
        "label":"first_seen",
        "type":"single",
        "sql":"min(encounter_datetime)"
      }
    ]
  }
]

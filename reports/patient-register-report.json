[
  {
    "name": "patient-register-report",
    "table": {
      "schema": "etl",
      "tableName": "flat_hiv_summary_staging",
      "alias": "t1"
    },
    "joins": [
      {
        "joinType": "INNER JOIN",
        "schema": "amrs",
        "tableName": "location",
        "alias": "t2",
        "joinExpression": "t1.location_uuid = t2.uuid"
      },
      {
        "joinType": "LEFT OUTER JOIN",
        "schema": "amrs",
        "tableName": "patient_identifier",
        "alias": "t4",
        "joinExpression": "t1.person_id = t4.patient_id"
      },
      {
        "joinType": "INNER JOIN",
        "schema": "amrs",
        "tableName": "person",
        "alias": "t5",
        "joinExpression": "t1.person_id = t5.person_id"
      }
    ],
    "parameters": [
      {
        "name": "startDate",
        "defaultValue": [
          "10-10-2015"
        ]
      },
      {
        "name": "endDate",
        "defaultValue": [
          "defaultValue"
        ]
      },
      {
        "name": "locations",
        "defaultValue": []
      },
      {
        "name": "startAge",
        "defaultValue": []
      },
      {
        "name": "endAge",
        "defaultValue": []
      },
      {
        "name": "gender",
        "defaultValue": []
      },
      {
        "name": "groupByPerson",
        "defaultValue": [
          {
            "label": "person",
            "expression": "t1.person_id"
          }
        ]
      }
    ],
    "filters": [
      {
        "expression": "date(t1.encounter_datetime) >= ?",
        "parameter": "startDate"
      },
      {
        "expression": "date(t1.encounter_datetime) <= ?",
        "parameter": "endDate"
      },
      {
        "expression": "t1.location_id in ?",
        "parameter": "locations"
      },
      {
        "expression": "t1.is_clinical_encounter = 1",
        "processForce": true
      },
      {
        "expression": "coalesce(t1.death_date, out_of_care) is null",
        "processForce": true
      },
      {
        "expression": "(timestampdiff(week, vl_1_date,encounter_datetime) <= 52 and vl_1 > 1000)",
        "processForce": true
      },
      {
        "expression": "(t1.next_clinical_datetime_hiv is null or next_clinical_datetime_hiv  >= ?)",
        "parameter": "endDate"
      }
    ],
    "groupClause": [
      {
        "parameter": "groupByPerson"
      }
    ],
    "indicators": [
      {
        "label": "cur_arv_meds",
        "expression": "cur_arv_meds",
        "sql": "$expression"
      }
    ],
    "supplementColumns": [
      {
        "label": "location",
        "type": "single",
        "sql": "t2.name"
      },
      {
        "label": "identifiers",
        "type": "multiple",
        "sql": "group_concat(distinct t4.identifier separator ', ')"
      },
      {
        "label": "age",
        "type": "single",
        "sql": "extract(year from (from_days(datediff(now(), t5.birthdate))))"
      },
      {
        "label": "gender",
        "type": "single",
        "sql": "t5.gender"
      },
      {
        "label": "last_visit_date",
        "type": "single",
        "sql": "DATE_FORMAT(t1.encounter_datetime, '%d/%m/%Y')"
      },
      {
        "label": "rtc_date",
        "type": "single",
        "sql": "DATE_FORMAT(t1.rtc_date, '%d/%m/%Y')"
      },
      {
        "label": "art_initiation_date",
        "type": "single",
        "sql": "DATE_FORMAT(t1.arv_first_regimen_start_date, '%d/%m/%Y')"
      },
      {
        "label": "current_art_start_date",
        "type": "single",
        "sql": "DATE_FORMAT(t1.arv_start_date, '%d/%m/%Y')"
      },
      {
        "label": "cur_art_regimen_duration",
        "type": "single",
        "sql": "timestampdiff(day,t1.arv_start_date,'2016-08-30')"
      },
      {
        "label": "cur_arv_line",
        "type": "single",
        "sql": "t1.cur_arv_line"
      },
      {
        "label": "cur_who_stage",
        "type": "single",
        "sql": "t1.cur_who_stage"
      },
      {
        "label": "cur_viral_load",
        "type": "single",
        "sql": "t1.vl_1"
      },
      {
        "label": "cur_viral_load_date",
        "type": "single",
        "sql": "DATE_FORMAT(t1.vl_1_date, '%d/%m/%Y')"
      },
      {
        "label": "prev_viral_load",
        "type": "single",
        "sql": "t1.prev_vl_1"
      },
      {
        "label": "prev_viral_load_date",
        "type": "single",
        "sql": "DATE_FORMAT(t1.prev_vl_1_date, '%d/%m/%Y')"
      },
      {
        "label": "prev_arv_adherence",
        "type": "single",
        "sql": "t1.prev_arv_adherence"
      },
      {
        "label": "cur_arv_adherence",
        "type": "single",
        "sql": "t1.cur_arv_adherence"
      },
      {
        "label": "disclosure_status",
        "type": "single",
        "sql": "case when hiv_status_disclosed= 1 then 'Disclosed' when  hiv_status_disclosed=0 then 'Not Disclosed' else  'N/A'  end "
      }
    ],
    "orderBy": [
      {
        "column": "encounter_datetime",
        "order": "desc",
        "name": "orderByDate"
      }
    ],
    "indicatorHandlers": [
      {
        "processor": "convertConceptIdToName",
        "indicators": [
          "cur_arv_meds"
        ]
      }
    ]
  }
]
